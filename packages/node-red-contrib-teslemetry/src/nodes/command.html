<script type="text/javascript">
    RED.nodes.registerType("command", {
        category: "Teslemetry Vehicle",
        color: "#cc0000",
        defaults: {
            name: { value: "" },
            teslemetryConfig: {
                value: "",
                type: "teslemetry-config",
                required: true,
            },
            vin: { value: "" },
            command: { value: "vehicleData" },
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-car",
        label: function () {
            return this.name || "Command: " + (this.command || "Data");
        },
        oneditprepare: function () {
            const node = this;
            const vinSelect = $("#node-input-vin");
            const configInput = $("#node-input-teslemetryConfig");

            function updateVins() {
                const configId = configInput.val();
                if (configId && configId !== "_ADD_") {
                    $.getJSON("teslemetry/vehicles", { config: configId })
                        .done(function (data) {
                            const current = vinSelect.val() || node.vin;
                            vinSelect.empty();
                            vinSelect.append(
                                '<option value="">From msg.vin</option>',
                            );
                            if (data && data.length > 0) {
                                data.forEach(function (v) {
                                    vinSelect.append(
                                        '<option value="' +
                                            v.vin +
                                            '">' +
                                            v.display_name +
                                            " (" +
                                            v.vin +
                                            ")</option>",
                                    );
                                });
                            }
                            if (current) {
                                vinSelect.val(current);
                            }
                        })
                        .fail(function (jqxhr, textStatus, error) {
                            console.error("Failed to fetch vehicles", error);
                        });
                }
            }

            configInput.change(function () {
                updateVins();
            });

            // Initial load if config is already selected
            if (configInput.val()) {
                updateVins();
            }
        },
    });
</script>

<script type="text/html" data-template-name="command">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-teslemetryConfig"
            ><i class="fa fa-globe"></i> Config</label
        >
        <input type="text" id="node-input-teslemetryConfig" />
    </div>
    <div class="form-row">
        <label for="node-input-vin"><i class="fa fa-car"></i> VIN</label>
        <select id="node-input-vin" style="width: 70%;">
            <option value="">From msg.vin</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-command"
            ><i class="fa fa-cogs"></i> Command</label
        >
        <select id="node-input-command">
            <option value="vehicleData">Get Vehicle Data</option>
            <option value="wakeUp">Wake Up</option>

            <optgroup label="Controls">
                <option value="flashLights">Flash Lights</option>
                <option value="honkHorn">Honk Horn</option>
                <option value="lockDoors">Lock Doors</option>
                <option value="unlockDoors">Unlock Doors</option>
                <option value="remoteStart">Remote Start</option>
                <option value="actuateTrunkRear">Open Rear Trunk</option>
                <option value="actuateTrunkFront">Open Front Trunk</option>
            </optgroup>

            <optgroup label="Climate">
                <option value="startAutoConditioning">Start HVAC</option>
                <option value="stopAutoConditioning">Stop HVAC</option>
                <option value="setSteeringWheelHeaterOn">
                    Enable Steering Wheel Heater
                </option>
                <option value="setSteeringWheelHeaterOff">
                    Disable Steering Wheel Heater
                </option>
                <option value="setTemps">Set Temps (msg.driver_temp)</option>
                <option value="setSeatHeater">
                    Set Seat Heater (msg.heater, msg.level)
                </option>
            </optgroup>

            <optgroup label="Charging">
                <option value="startCharging">Start Charging</option>
                <option value="stopCharging">Stop Charging</option>
                <option value="openChargePort">Open Charge Port</option>
                <option value="closeChargePort">Close Charge Port</option>
                <option value="setChargeLimit">
                    Set Charge Limit (msg.percent)
                </option>
                <option value="setChargingAmps">
                    Set Charging Amps (msg.charging_amps)
                </option>
            </optgroup>

            <optgroup label="Security">
                <option value="setSentryModeOn">Enable Sentry Mode</option>
                <option value="setSentryModeOff">Disable Sentry Mode</option>
            </optgroup>

            <optgroup label="Advanced">
                <option value="triggerHomelink">
                    Trigger Homelink (msg.lat, msg.lon)
                </option>
                <option value="navigationRequest">
                    Navigation Request (msg.payload)
                </option>
            </optgroup>
        </select>
    </div>
</script>

<script type="text/html" data-help-name="command">
    <p>Interacts with a vehicle via Teslemetry API.</p>
    <p>Requires a valid Teslemetry configuration and a VIN.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">vin <span class="property-type">string</span></dt>
        <dd>Vehicle Identification Number (if not set in config)</dd>
        <dt class="optional">
            command <span class="property-type">string</span>
        </dt>
        <dd>Command to execute (overrides config)</dd>
        <dt class="optional">
            payload <span class="property-type">object</span>
        </dt>
        <dd>
            Arguments for commands (e.g. <code>{ "percent": 80 }</code> for Set
            Charge Limit)
        </dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>The response from the API.</dd>
    </dl>
</script>
