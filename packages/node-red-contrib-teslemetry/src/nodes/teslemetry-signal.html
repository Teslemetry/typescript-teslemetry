<script type="text/javascript">
    RED.nodes.registerType("teslemetry-signal", {
        category: "Teslemetry Vehicle",
        paletteLabel: "Signal",
        color: "#cc0000",
        defaults: {
            name: { value: "" },
            teslemetryConfig: {
                value: "",
                type: "teslemetry-config",
                required: true,
            },
            vin: { value: "", required: true },
            field: { value: "", required: true },
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-bolt",
        label: function () {
            return this.name || "Signal: " + (this.field || "...");
        },
        oneditprepare: function () {
            const node = this;
            const vinSelect = $("#node-input-vin");
            const fieldSelect = $("#node-input-field");
            const configInput = $("#node-input-teslemetryConfig");

            function updateVins() {
                const configId = configInput.val();
                if (configId && configId !== "_ADD_") {
                    $.getJSON("teslemetry/vehicles", { config: configId })
                        .done(function (data) {
                            const current = vinSelect.val() || node.vin;
                            vinSelect.empty();
                            if (data && data.length > 0) {
                                data.forEach(function ([id, name]) {
                                    vinSelect.append(
                                        '<option value="' +
                                            id +
                                            '">' +
                                            name +
                                            " (" +
                                            id +
                                            ")</option>",
                                    );
                                });
                            }
                            if (current) {
                                vinSelect.val(current);
                            }
                        })
                        .fail(function (jqxhr, textStatus, error) {
                            console.error("Failed to fetch vehicles", error);
                        });
                }
            }

            function updateFields() {
                const configId = configInput.val();
                if (configId && configId !== "_ADD_") {
                    $.getJSON("teslemetry/fields", { config: configId })
                        .done(function (data) {
                            const current = fieldSelect.val() || node.field;
                            fieldSelect.empty();
                            if (data && data.length > 0) {
                                data.forEach(function (f) {
                                    fieldSelect.append(
                                        '<option value="' +
                                            f +
                                            '">' +
                                            f +
                                            "</option>",
                                    );
                                });
                            }
                            if (current) {
                                fieldSelect.val(current);
                            }
                        })
                        .fail(function (jqxhr, textStatus, error) {
                            console.error("Failed to fetch fields", error);
                        });
                }
            }

            configInput.change(function () {
                updateVins();
                updateFields();
            });

            if (configInput.val()) {
                updateVins();
                updateFields();
            }
        },
    });
</script>

<script type="text/html" data-template-name="teslemetry-signal">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-teslemetryConfig"
            ><i class="fa fa-globe"></i> Config</label
        >
        <input type="text" id="node-input-teslemetryConfig" />
    </div>
    <div class="form-row">
        <label for="node-input-vin"><i class="fa fa-car"></i> VIN</label>
        <select id="node-input-vin" style="width: 70%;"></select>
    </div>
    <div class="form-row">
        <label for="node-input-field"><i class="fa fa-tag"></i> Field</label>
        <select id="node-input-field" style="width: 70%;">
            <option value="">From msg.field</option>
        </select>
    </div>
</script>

<script type="text/html" data-help-name="teslemetry-signal">
    <p>Listens for a specific signal field from a vehicle.</p>
    <p>
        Requires a VIN and a Field name. The field can be selected from the
        dropdown or provided via <code>msg.field</code>.
    </p>
</script>
